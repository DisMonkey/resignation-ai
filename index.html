/* Resignation AI — Free, Offline, Mobile + Desktop
 * Fixes:
 * - Wrap all setup in DOMContentLoaded so elements exist before we bind.
 * - Safe listeners with null checks.
 * - Clean tone/language templates.
 */

(function () {
  // Helpers
  const el = (id) => document.getElementById(id);
  const on = (node, evt, fn) => node && node.addEventListener(evt, fn);

  function fmtDateLocale(iso, langCode) {
    if (!iso) return "";
    try {
      const d = new Date(iso + "T00:00:00");
      return d.toLocaleDateString(langCode, { year: "numeric", month: "long", day: "numeric" });
    } catch {
      return iso;
    }
  }

  function capFirst(s) {
    if (!s) return "";
    const t = s.trim();
    return t ? t.charAt(0).toUpperCase() + t.slice(1) : "";
  }

  // Tone templates (EN + ES)
  const TONES = {
    en: {
      formal: {
        greet: (m) => (m ? `Dear ${m},` : `To whom it may concern,`),
        open: (j, c, d) => `Please accept this letter as formal notice of my resignation from my position as ${j} at ${c}${d ? `, effective ${d}` : ""}.`,
        reason: (r) => (r ? `After careful consideration, I have decided to step down due to ${r}.` : ""),
        thanks: (c) => `I am grateful for the opportunities and experience I have gained at ${c}.`,
        transition: `I will do everything I can to ensure a smooth transition before my departure.`,
        close: `Sincerely,`,
      },
      polite: {
        greet: (m) => (m ? `Hi ${m},` : `Hello,`),
        open: (j, c, d) => `I’m writing to let you know I’m resigning from my role as ${j} at ${c}${d ? `, effective ${d}` : ""}.`,
        reason: (r) => (r ? `This wasn’t easy, but I’m leaving because ${r}.` : ""),
        thanks: (c) => `Thank you for the chance to grow at ${c}.`,
        transition: `I’ll help ensure a smooth hand-off.`,
        close: `Best regards,`,
      },
      honest: {
        greet: (m) => (m ? `Dear ${m},` : `Hello,`),
        open: (j, c, d) => `I’m submitting my resignation from my position as ${j} at ${c}${d ? `, with my last day on ${d}` : ""}.`,
        reason: (r) => (r ? `To be transparent, my decision is based on ${r}.` : ""),
        thanks: (c) => `I appreciate the experiences and relationships I’ve built at ${c}.`,
        transition: `I’ll document my responsibilities and support a smooth transition.`,
        close: `Respectfully,`,
      },
      simple: {
        greet: (m) => (m ? `Hi ${m},` : `Hi,`),
        open: (j, c, d) => `I’m resigning from my job as ${j} at ${c}${d ? `, and my last day will be ${d}` : ""}.`,
        reason: (r) => (r ? `I’m leaving because ${r}.` : ""),
        thanks: (c) => `Thanks for everything at ${c}.`,
        transition: `I’ll help with the handover.`,
        close: `Thanks,`,
      },
      grateful: {
        greet: (m) => (m ? `Dear ${m},` : `Dear Team,`),
        open: (j, c, d) => `Please accept this as my resignation from ${j} at ${c}${d ? `, effective ${d}` : ""}.`,
        reason: (r) => (r ? `I’ve decided to move on because ${r}.` : ""),
        thanks: (c) => `I’m truly grateful for the mentorship, trust, and opportunities at ${c}.`,
        transition: `I’ll do my best to make this an easy transition for everyone.`,
        close: `With appreciation,`,
      },
      light: {
        greet: (m) => (m ? `Hey ${m},` : `Hey there,`),
        open: (j, c, d) => `I’m letting you know I’ll be resigning from my role as ${j} at ${c}${d ? `, with ${d} as my last day` : ""}.`,
        reason: (r) => (r ? `The short version: I’m moving on because ${r}.` : ""),
        thanks: (c) => `I’ve learned a lot and I’m thankful for my time at ${c}.`,
        transition: `I’ll leave things tidy and share notes to keep everything rolling.`,
        close: `All the best,`,
      },
    },
    es: {
      formal: {
        greet: (m) => (m ? `Estimado/a ${m},` : `A quien corresponda:`),
        open: (j, c, d) => `Por medio de la presente, presento mi renuncia al puesto de ${j} en ${c}${d ? `, con fecha efectiva ${d}` : ""}.`,
        reason: (r) => (r ? `Tras una cuidadosa consideración, he decidido retirarme debido a ${r}.` : ""),
        thanks: (c) => `Agradezco las oportunidades y la experiencia adquiridas en ${c}.`,
        transition: `Haré todo lo posible para garantizar una transición ordenada antes de mi salida.`,
        close: `Atentamente,`,
      },
      polite: {
        greet: (m) => (m ? `Hola ${m},` : `Hola,`),
        open: (j, c, d) => `Le escribo para informarle que presento mi renuncia al puesto de ${j} en ${c}${d ? `, con fecha efectiva ${d}` : ""}.`,
        reason: (r) => (r ? `No fue una decisión fácil, pero me voy porque ${r}.` : ""),
        thanks: (c) => `Agradezco la oportunidad de haber crecido en ${c}.`,
        transition: `Apoyaré para que el traspaso sea lo más sencillo posible.`,
        close: `Saludos cordiales,`,
      },
      honest: {
        greet: (m) => (m ? `Estimado/a ${m},` : `Hola,`),
        open: (j, c, d) => `Presento mi renuncia al puesto de ${j} en ${c}${d ? `, siendo mi último día ${d}` : ""}.`,
        reason: (r) => (r ? `Con transparencia, esta decisión se basa en ${r}.` : ""),
        thanks: (c) => `Valoro las experiencias y relaciones construidas en ${c}.`,
        transition: `Dejaré documentadas mis tareas y apoyaré la transición.`,
        close: `Respetuosamente,`,
      },
      simple: {
        greet: (m) => (m ? `Hola ${m},` : `Hola,`),
        open: (j, c, d) => `Renuncio a mi trabajo como ${j} en ${c}${d ? `; mi último día será ${d}` : ""}.`,
        reason: (r) => (r ? `Me voy porque ${r}.` : ""),
        thanks: (c) => `Gracias por todo en ${c}.`,
        transition: `Ayudaré con el traspaso.`,
        close: `Gracias,`,
      },
      grateful: {
        greet: (m) => (m ? `Estimado/a ${m},` : `Estimado equipo,`),
        open: (j, c, d) => `Por favor, acepte esta carta como mi renuncia a ${j} en ${c}${d ? `, efectiva ${d}` : ""}.`,
        reason: (r) => (r ? `He decidido continuar con nuevos rumbos porque ${r}.` : ""),
        thanks: (c) => `Estoy muy agradecido/a por la confianza y el aprendizaje en ${c}.`,
        transition: `Haré todo lo posible para que la transición sea fácil para todos.`,
        close: `Con aprecio,`,
      },
      light: {
        greet: (m) => (m ? `Hola ${m},` : `Hola,`),
        open: (j, c, d) => `Quería comentarte que renuncio a mi puesto de ${j} en ${c}${d ? `; mi último día será ${d}` : ""}.`,
        reason: (r) => (r ? `En pocas palabras: me voy porque ${r}.` : ""),
        thanks: (c) => `Aprendí mucho y agradezco mi tiempo en ${c}.`,
        transition: `Dejaré todo en orden y notas para que todo siga funcionando.`,
        close: `Un saludo,`,
      },
    },
  };

  function buildLetter(d) {
    const lang = d.lang === "es" ? "es" : "en";
    const toneKey = TONES[lang][d.tone] ? d.tone : "polite";
    const t = TONES[lang][toneKey];

    const lastTxt = d.last ? fmtDateLocale(d.last, lang === "es" ? "es-ES" : undefined) : "";
    const parts = [
      t.greet(d.manager),
      t.open(d.job, d.company, lastTxt),
      d.reason ? t.reason(capFirst(d.reason)) : "",
      t.thanks(d.company),
      d.extra ? capFirst(d.extra) : t.transition,
      `${t.close}\n${d.name || ""}`,
    ].filter(Boolean);

    return parts.join("\n\n").trim();
  }

  function getFormData() {
    return {
      name: el("name")?.value.trim() || "",
      manager: el("manager")?.value.trim() || "",
      job: el("jobTitle")?.value.trim() || "Employee",
      company: el("company")?.value.trim() || "the company",
      last: el("lastDay")?.value || "",
      reason: el("reason")?.value.trim() || "",
      extra: el("extra")?.value.trim() || "",
      tone: el("tone")?.value || "polite",
      lang: el("language")?.value || "en",
    };
  }

  function toast(msg) {
    const t = document.createElement("div");
    t.textContent = msg;
    Object.assign(t.style, {
      position: "fixed",
      left: "50%",
      bottom: "22px",
      transform: "translateX(-50%)",
      background: "#1f2335",
      color: "#e6edf3",
      padding: "10px 14px",
      borderRadius: "10px",
      border: "1px solid #2b3150",
      boxShadow: "0 8px 20px rgba(0,0,0,.35)",
      zIndex: 9999,
      fontSize: "14px",
      opacity: "0",
      transition: "opacity .2s ease",
    });
    document.body.appendChild(t);
    requestAnimationFrame(() => (t.style.opacity = "1"));
    setTimeout(() => {
      t.style.opacity = "0";
      setTimeout(() => t.remove(), 220);
    }, 1700);
  }

  // Bind once DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    const noticeSel = el("notice");
    on(noticeSel, "change", () => {
      const days = parseInt(noticeSel.value, 10) || 0;
      const out = el("lastDay");
      if (!out) return;
      if (days <= 0) {
        out.value = "";
        return;
      }
      const d = new Date();
      d.setDate(d.getDate() + days);
      out.value = d.toISOString().split("T")[0];
    });

    on(el("generateBtn"), "click", () => {
      const d = getFormData();
      if (!d.name) return alert(d.lang === "es" ? "Ingrese su nombre completo." : "Please enter your full name.");
      if (!d.job) return alert(d.lang === "es" ? "Ingrese su puesto." : "Please enter your job title.");
      if (!d.company) return alert(d.lang === "es" ? "Ingrese su empresa." : "Please enter your company.");

      const letter = buildLetter(d);
      const out = el("output");
      if (out) out.value = letter;
      toast(d.lang === "es" ? "Carta generada." : "Letter generated.");
    });

    on(el("copyBtn"), "click", async () => {
      const txt = el("output")?.value || "";
      if (!txt.trim()) return;
      try {
        await navigator.clipboard.writeText(txt);
        toast("Copied to clipboard!");
      } catch {
        toast("Copy failed—select and copy manually.");
      }
    });

    on(el("downloadBtn"), "click", () => {
      const txt = el("output")?.value || "";
      if (!txt.trim()) return;
      const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      const safeName = (el("name")?.value.trim() || "resignation").replace(/\s+/g, "_");
      a.href = URL.createObjectURL(blob);
      a.download = `${safeName}_letter.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    });

    on(el("emailBtn"), "click", () => {
      const txt = el("output")?.value || "";
      if (!txt.trim()) return;
      const subject = encodeURIComponent("Resignation Letter");
      const body = encodeURIComponent(txt);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    });

    on(el("clearBtn"), "click", () => {
      ["name", "manager", "jobTitle", "company", "lastDay", "reason", "extra"].forEach((id) => {
        const n = el(id);
        if (!n) return;
        n.value = "";
      });
      if (el("tone")) el("tone").value = "polite";
      if (el("language")) el("language").value = "en";
      if (el("notice")) el("notice").value = "14";
      el("output") && (el("output").value = "");
      toast("Cleared.");
    });
  });
})();
